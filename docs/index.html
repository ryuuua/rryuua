<!doctype html>
<html lang="ja">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Plotly Hierarchical Gallery</title>
<link rel="icon" href="data:,">
<style>
  :root { --bg:#fff; --card:#fafafa; --line:#eee; --text:#222; --muted:#666; }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
       margin:0; color:var(--text); background:var(--bg)}
  header{padding:14px 18px; border-bottom:1px solid var(--line); display:flex; gap:12px; align-items:center}
  header input{flex:1; max-width:520px; padding:10px 12px; border:1px solid var(--line); border-radius:12px; font-size:14px}
  main{display:grid; grid-template-columns: 320px 1fr; min-height: calc(100vh - 56px)}
  nav{border-right:1px solid var(--line); padding:14px; overflow:auto}
  #tree ul{list-style:none; padding-left:14px; margin:4px 0}
  #tree li{margin:2px 0}
  .dir > span{cursor:pointer; user-select:none; padding:4px 6px; border-radius:8px}
  .dir > span:hover{background:var(--card)}
  .leaf a{display:inline-block; padding:2px 6px; border-radius:8px; text-decoration:none; color:inherit}
  .leaf a:hover{background:var(--card)}
  .muted{color:var(--muted); font-size:12px}
  #viewer{position:relative; padding:16px; overflow:hidden}
  #frame{width:100%; height: calc(100vh - 56px - 32px); border:0; border-radius:12px; opacity:1; transition:opacity .2s ease}
  #frame.fade{opacity:0}
  #breadcrumb{font-size:13px; color:var(--muted); margin:0 0 8px 4px}
  #breadcrumb a{text-decoration:none; color:inherit}
  .card{background:var(--card); padding:8px 10px; border-radius:10px; display:inline-block}
</style>
<header>
  <strong>üìä Plotly Gallery</strong>
  <input id="search" placeholder="Ê§úÁ¥¢Ôºà„Éï„Ç©„É´„ÉÄÂêç„ÉªÂõ≥ÂêçÔºâ">
  <span class="muted">ÈöéÂ±§„Çí„ÇØ„É™„ÉÉ„ÇØ‚ñ∂„ÅßÂ±ïÈñã</span>
</header>
<main>
  <nav>
    <div id="tree" aria-label="Navigation tree"></div>
  </nav>
  <section id="viewer">
    <div id="breadcrumb"></div>
    <iframe id="frame" title="Plot viewer" src=""></iframe>
  </section>
</main>

<script>
const S = {
  manifestUrl: 'manifest.json',
  defaultPlotUrl: 'default_plot.txt'
};

let manifest, flatLeaves=[];

async function loadManifest(){
  const [m, d] = await Promise.all([
    fetch(S.manifestUrl).then(r=>r.json()),
    fetch(S.defaultPlotUrl).then(r=>r.text()).catch(()=>({text:''}))
  ]);
  manifest = m;
  buildTree();
  routeFromHash(d.trim());
}

function buildTree(){
  const treeEl = document.getElementById('tree');
  treeEl.innerHTML = '';
  flatLeaves = [];
  const ul = document.createElement('ul');
  for (const child of manifest.children || []) ul.appendChild(nodeToLi(child, []));
  treeEl.appendChild(ul);
}

function nodeToLi(node, path){
  const li = document.createElement('li');
  if (node.path){
    const leaf = document.createElement('div'); leaf.className='leaf';
    const a = document.createElement('a');
    a.href = '#/' + [...path, node.title].join('/');
    a.textContent = node.title;
    a.onclick = (e)=>{ e.preventDefault(); navigateTo(a.href.split('#/')[1]); };
    leaf.appendChild(a); li.appendChild(leaf);
    flatLeaves.push({path:[...path, node.title], url: node.path, title: node.title});
  } else {
    const dir = document.createElement('div'); dir.className='dir';
    const label = document.createElement('span'); label.textContent = '‚ñ∂ ' + node.title;
    const ul = document.createElement('ul'); ul.style.display='none';
    label.onclick = ()=>{
      const open = ul.style.display !== 'none';
      ul.style.display = open ? 'none' : 'block';
      label.textContent = (open ? '‚ñ∂ ' : '‚ñº ') + node.title;
    };
    dir.appendChild(label); li.appendChild(dir);
    const kids = document.createElement('ul');
    for (const child of node.children || []) kids.appendChild(nodeToLi(child, [...path, node.title]));
    ul.replaceWith(kids); li.appendChild(kids);
  }
  return li;
}

function routeFromHash(defaultUrl){
  const hash = decodeURIComponent(location.hash.replace(/^#\/?/,''));
  if (!hash){
    if (defaultUrl) return loadPlotByUrl(defaultUrl, ['(default)']);
    // „Å™„Åë„Çå„Å∞ÂÖàÈ†≠„ÅÆleaf
    if (flatLeaves[0]) loadPlotByUrl(flatLeaves[0].url, flatLeaves[0].path);
    return;
  }
  // „Éè„ÉÉ„Ç∑„É• "/A/B/name" ‚Üí leaf „ÇíÊé¢Á¥¢
  const parts = hash.split('/').filter(Boolean);
  const match = flatLeaves.find(l => l.path.join('/').toLowerCase() === parts.join('/').toLowerCase());
  if (match) loadPlotByUrl(match.url, match.path);
}

function navigateTo(pathStr){
  location.hash = '#/' + pathStr;
}

function setBreadcrumb(path){
  const bc = document.getElementById('breadcrumb');
  if (!path || !path.length){ bc.innerHTML=''; return; }
  const links = [];
  for (let i=0; i<path.length; i++){
    const seg = path.slice(0,i+1).join('/');
    links.push(`<a href="#/${encodeURIComponent(seg).replace(/%2F/g,'/')}">${path[i]}</a>`);
  }
  bc.innerHTML = `<span class="card">${links.join(' / ')}</span>`;
}

let loading = false;
function loadPlotByUrl(url, path){
  if (loading) return;
  loading = true;
  const iframe = document.getElementById('frame');
  setBreadcrumb(path);
  iframe.classList.add('fade');
  // „Åª„Çì„ÅÆÂ∞ë„ÅóÂæÖ„Å£„Å¶„Éï„Çß„Éº„Éâ‚ÜísrcÂàáÊõø‚ÜíË™≠„ÅøËæº„ÅøÂÆå‰∫Ü„Åß„Éï„Çß„Éº„Éâ„Ç§„É≥
  setTimeout(()=>{
    iframe.onload = ()=>{ iframe.classList.remove('fade'); loading=false; };
    iframe.src = 'plots/' + url;
  }, 120);
}

document.getElementById('search').addEventListener('input', (e)=>{
  const q = e.target.value.trim().toLowerCase();
  const treeEl = document.getElementById('tree');
  if (!q){ buildTree(); return; }
  // „Éû„ÉÉ„ÉÅ„Åó„Åü leaf „ÇíÂπ≥Âù¶„Å´Ë°®Á§∫
  const ul = document.createElement('ul');
  flatLeaves
    .filter(l => l.title.toLowerCase().includes(q) || l.path.join('/').toLowerCase().includes(q))
    .forEach(l=>{
      const li = document.createElement('li');
      li.innerHTML = `<div class="leaf"><a href="#/${l.path.join('/')}">${l.path.join(' / ')}</a></div>`;
      li.querySelector('a').onclick = (ev)=>{ ev.preventDefault(); navigateTo(l.path.join('/')); };
      ul.appendChild(li);
    });
  treeEl.innerHTML = ''; treeEl.appendChild(ul);
});

window.addEventListener('hashchange', ()=>routeFromHash());
loadManifest();
</script>
</html>